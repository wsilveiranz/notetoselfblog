<!DOCTYPE html>
<html lang="en">
<head>

    <title>Acessing Event Hubs with Confluent Kafka Library</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preload" as="style" href="/notetoselfblog/assets/built/screen.css?v=c95e7abf59">
    <link rel="preload" as="script" href="/notetoselfblog/assets/built/source.js?v=c95e7abf59">

    <link rel="stylesheet" type="text/css" href="/notetoselfblog/assets/built/screen.css?v=c95e7abf59">

    <style>
        :root {
            --background-color: #ffffff
        }
    </style>

    <script>
        /* The script for calculating the color contrast has been taken from
        https://gomakethings.com/dynamically-changing-the-text-color-based-on-background-color-contrast-with-vanilla-js/ */
        var accentColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color');
        accentColor = accentColor.trim().slice(1);
        var r = parseInt(accentColor.substr(0, 2), 16);
        var g = parseInt(accentColor.substr(2, 2), 16);
        var b = parseInt(accentColor.substr(4, 2), 16);
        var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        var textColor = (yiq >= 128) ? 'dark' : 'light';

        document.documentElement.className = `has-${textColor}-text`;
    </script>

    <link rel="canonical" href="http://wsilveiranz.github.io/notetoselfblog/acessing-event-hubs-with-confluent-kafka-library/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Note to Self - Ghost Edition">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Acessing Event Hubs with Confluent Kafka Library">
    <meta property="og:description" content="A while ago, I was involved in a project that needed to push messages to a Kafka topic. I found that while the .NET code required for that implementation was relatively straight-forward – thanks to the Confluent’s .NET client for Kafka –  configuring the server was a nightmare. The IT team">
    <meta property="og:url" content="http://wsilveiranz.github.io/notetoselfblog/acessing-event-hubs-with-confluent-kafka-library/">
    <meta property="og:image" content="https://static.ghost.org/v5.0.0/images/publication-cover.jpg">
    <meta property="article:published_time" content="2018-06-03T01:55:13.000Z">
    <meta property="article:modified_time" content="2018-06-03T18:19:33.000Z">
    
    <meta property="article:publisher" content="https://www.facebook.com/ghost">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Acessing Event Hubs with Confluent Kafka Library">
    <meta name="twitter:description" content="A while ago, I was involved in a project that needed to push messages to a Kafka topic. I found that while the .NET code required for that implementation was relatively straight-forward – thanks to the Confluent’s .NET client for Kafka –  configuring the server was a nightmare. The IT team">
    <meta name="twitter:url" content="http://wsilveiranz.github.io/notetoselfblog/acessing-event-hubs-with-confluent-kafka-library/">
    <meta name="twitter:image" content="https://static.ghost.org/v5.0.0/images/publication-cover.jpg">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="wsilveiranz">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="">
    <meta name="twitter:site" content="@ghost">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="840">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Note to Self - Ghost Edition",
        "url": "http://wsilveiranz.github.io/notetoselfblog/",
        "logo": {
            "@type": "ImageObject",
            "url": "http://wsilveiranz.github.io/notetoselfblog/favicon.ico"
        }
    },
    "author": {
        "@type": "Person",
        "name": "wsilveiranz",
        "image": {
            "@type": "ImageObject",
            "url": "https://secure.gravatar.com/avatar/8cf8f21650fd5355a5b2c08e0f9ca914?s=512&d=mm&r=g",
            "width": 512,
            "height": 512
        },
        "url": "http://wsilveiranz.github.io/notetoselfblog/author/wsilveiranz/",
        "sameAs": []
    },
    "headline": "Acessing Event Hubs with Confluent Kafka Library",
    "url": "http://wsilveiranz.github.io/notetoselfblog/acessing-event-hubs-with-confluent-kafka-library/",
    "datePublished": "2018-06-03T01:55:13.000Z",
    "dateModified": "2018-06-03T18:19:33.000Z",
    "description": "A while ago, I was involved in a project that needed to push messages to a Kafka topic. I found that while the .NET code required for that implementation was relatively straight-forward – thanks to the Confluent’s .NET client for Kafka –  configuring the server was a nightmare. The IT team at the client site was supposed to get the kafka cluster sorted and dragged the issue for a month or so. And I understood why when I tried to setup a cluster myself – configuring a kafka cluster is not a walk ",
    "mainEntityOfPage": "http://wsilveiranz.github.io/notetoselfblog/acessing-event-hubs-with-confluent-kafka-library/"
}
    </script>

    <meta name="generator" content="Ghost 5.75">
    <link rel="alternate" type="application/rss+xml" title="Note to Self - Ghost Edition" href="http://wsilveiranz.github.io/notetoselfblog/rss/">
    <script defer src="https://cdn.jsdelivr.net/ghost/portal@~2.36/umd/portal.min.js" data-i18n="false" data-ghost="http://wsilveiranz.github.io/notetoselfblog/" data-key="4d946a7b27dfe0cf2428731cab" data-api="http://wsilveiranz.github.io/notetoselfblog/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="4d946a7b27dfe0cf2428731cab" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="http://wsilveiranz.github.io/notetoselfblog/" crossorigin="anonymous"></script>
    
    <link href="http://wsilveiranz.github.io/notetoselfblog/webmentions/receive/" rel="webmention">
    <script defer src="/public/member-attribution.min.js?v=c95e7abf59"></script><style>:root {--ghost-accent-color: #FF1A75;}</style>

</head>
<body class="post-template tag-hash-wordpress tag-hash-import-2023-12-17-09-11 has-sans-title has-sans-body">

<div class="gh-viewport">
    
    <header id="gh-navigation" class="gh-navigation is-middle-logo gh-outer">
    <div class="gh-navigation-inner gh-inner">

        <div class="gh-navigation-brand">
            <a class="gh-navigation-logo is-title" href="http://wsilveiranz.github.io/notetoselfblog">
                    Note to Self - Ghost Edition
            </a>
            <button class="gh-search gh-icon-button" aria-label="Search this site" data-ghost-search>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>            <button class="gh-burger gh-icon-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path></svg>                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>            </button>
        </div>

        <nav class="gh-navigation-menu">
            <ul class="nav">
    <li class="nav-home"><a href="http://wsilveiranz.github.io/notetoselfblog/">Home</a></li>
    <li class="nav-about"><a href="http://wsilveiranz.github.io/notetoselfblog/about/">About</a></li>
</ul>

        </nav>

        <div class="gh-navigation-actions">
                <button class="gh-search gh-icon-button" aria-label="Search this site" data-ghost-search>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>                <div class="gh-navigation-members">
                            <a href="#/portal/signin" data-portal="signin">Sign in</a>
                                <a class="gh-button" href="#/portal/signup" data-portal="signup">Subscribe</a>
                </div>
        </div>

    </div>
</header>

    

<main class="gh-main">

    <article class="gh-article post tag-hash-wordpress tag-hash-import-2023-12-17-09-11 no-image">

        <header class="gh-article-header gh-canvas">

            <h1 class="gh-article-title is-title">Acessing Event Hubs with Confluent Kafka Library</h1>

            <div class="gh-article-meta">
                <div class="gh-article-author-image">
                            <a href="/author/wsilveiranz/">
                                <img class="author-profile-image" src="https://secure.gravatar.com/avatar/8cf8f21650fd5355a5b2c08e0f9ca914?s&#x3D;512&amp;d&#x3D;mm&amp;r&#x3D;g" alt="wsilveiranz" />
                            </a>
                </div>
                <div class="gh-article-meta-wrapper">
                    <h4 class="gh-article-author-name"><a href="/author/wsilveiranz/">wsilveiranz</a></h4>
                    <div class="gh-article-meta-content">
                        <time class="gh-article-meta-date" datetime="2018-06-03">Jun 3, 2018</time>
                            <span class="gh-article-meta-length"><span class="bull">—</span> 8 min read</span>
                    </div>
                </div>
            </div>

            
        </header>

        <section class="gh-content gh-canvas is-body">
            <!--kg-card-begin: html--><p>A while ago, I was involved in a project that needed to push messages to a Kafka topic. I found that while the .NET code required for that implementation was relatively straight-forward &#8211; thanks to the <a href="https://github.com/confluentinc/confluent-kafka-dotnet?ref=localhost" target="_blank" rel="noopener">Confluent&#8217;s .NET client for Kafka</a> &#8211;  configuring the server was a nightmare. The IT team at the client site was supposed to get the kafka cluster sorted and dragged the issue for a month or so. And I understood why when I tried to setup a cluster myself &#8211; configuring a kafka cluster is not a walk in the park. If only we had a managed, one click solution to implement a event streaming solution, based on kafka protocol&#8230; 😀</p>
<p>When Microsoft announced last month Event Hubs support for the Kafka protocol &#8211; I thought that a great way to prove that this was really interoperable, was to use part of the original code I wrote and see if I could connect to Event Hubs without any significant changes. And I was pleasantly surprised! The only changes required was some additions to the producer/consumer configuration. This post shows how I managed to get this working, and show one of the main gotchas I found along the way.<!--more--></p>
<h2>Setting Up Kafka Support on Event Hubs</h2>
<p>First I needed an Event Hubs namespace with Kafka support enabled &#8211; this correlates to a kafka cluster. This can be achieved by simply enabling Kafka support when you create a new Event Hubs namespace. It is that simple to provision!</p>
<p><img loading="lazy" class="alignnone size-large wp-image-2567" src="https://i0.wp.com/notetoself.tech/content/images/wordpress/2018/05/Enable_kafka-1024x757.png?resize=840%2C621" alt width="840" height="621" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/Enable_kafka-1024x757.png 1024w, http://localhost:2368/content/images/wordpress/2018/05/Enable_kafka-300x222.png 300w, http://localhost:2368/content/images/wordpress/2018/05/Enable_kafka-768x568.png 768w, http://localhost:2368/content/images/wordpress/2018/05/Enable_kafka-1200x887.png 1200w, http://localhost:2368/content/images/wordpress/2018/05/Enable_kafka.png 1277w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px" data-recalc-dims="1"></p>
<p>For a step-by-step guide, you can follow <a href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-create-kafka-enabled?ref=localhost" target="_blank" rel="noopener">Microsoft Docs documentation</a>.</p>
<p>Once the Event Hub namespace with kafka support is deployed, you will need to create a new event hub &#8211; which relates to a kafka topic &#8211; and setup an access policy for that event hub (you can always use the RootManageShareAccessKey, but that is not good practice).</p>
<blockquote><p>As far as I understand this must be done when the namespace is created. So bear that in mind when creating a new event hub namespace.</p></blockquote>
<h3>Creating a New Event Hub Instance</h3>
<p>Next I needed a new event hub instance. The simplest way to create a new event hub instance is to navigate to your event hub namespace and click on the (+) Event Hub at the top of the overview blade.</p>
<p><img loading="lazy" class="alignnone size-large wp-image-2569" src="https://i0.wp.com/notetoself.tech/content/images/wordpress/2018/05/new_event_hub-1024x450.png?resize=840%2C369" alt width="840" height="369" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/new_event_hub-1024x450.png 1024w, http://localhost:2368/content/images/wordpress/2018/05/new_event_hub-300x132.png 300w, http://localhost:2368/content/images/wordpress/2018/05/new_event_hub-768x337.png 768w, http://localhost:2368/content/images/wordpress/2018/05/new_event_hub-1200x527.png 1200w, http://localhost:2368/content/images/wordpress/2018/05/new_event_hub.png 1680w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px" data-recalc-dims="1"></p>
<p>Once the create blade appears, fill in the required information and click create:</p>
<p><img loading="lazy" class="alignnone wp-image-2570" src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/create_event_hub-284x300.png" alt width="324" height="342" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/create_event_hub-284x300.png 284w, http://localhost:2368/content/images/wordpress/2018/05/create_event_hub-768x812.png 768w, http://localhost:2368/content/images/wordpress/2018/05/create_event_hub-969x1024.png 969w, http://localhost:2368/content/images/wordpress/2018/05/create_event_hub.png 988w" sizes="(max-width: 324px) 85vw, 324px"></p>
<p>A couple of things to take in consideration while creating an event hub:</p>
<ul>
<li>Partition count &#8211; partition count indicate the number of parallel consumers you can have processing your events. You can find more information about partition <a href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-features?ref=localhost#partitions" target="_blank" rel="noopener">here</a>.</li>
<li>Message retention &#8211; define the number of days a message is retained on Event Hubs &#8211; messages are not deleted explicitly on event hubs, but expiry after the message retention period.</li>
</ul>
<blockquote><p>Partition count is another design consideration as it cannot change after you provision your namespace. So make sure you plan ahead when setting that up.</p></blockquote>
<h3>Setup a Shared Access Policy</h3>
<p>Finally I needed a way to connect to the event hubs. For that I needed to create a Shared Access Policy &#8211; I decided to create a key for a single event hub instance, so I navigated to that instance and selected Shared access policies.</p>
<p><img loading="lazy" class="alignnone wp-image-2573 size-large" src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/create_sas_policy-1024x685.png" alt width="840" height="562" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/create_sas_policy-1024x685.png 1024w, http://localhost:2368/content/images/wordpress/2018/05/create_sas_policy-300x201.png 300w, http://localhost:2368/content/images/wordpress/2018/05/create_sas_policy-768x514.png 768w, http://localhost:2368/content/images/wordpress/2018/05/create_sas_policy.png 1118w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<p>Within Shared access policies you just need to click on (+) Add <img loading="lazy" class="wp-image-2575 alignnone" src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/sas_add.png" alt width="367" height="366" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/sas_add.png 730w, http://localhost:2368/content/images/wordpress/2018/05/sas_add-150x150.png 150w, http://localhost:2368/content/images/wordpress/2018/05/sas_add-300x300.png 300w" sizes="(max-width: 367px) 85vw, 367px"></p>
<p>At the Add SAS Policy, choose a name for your policy and what rights you want to give for that policy.</p>
<p><img loading="lazy" class="wp-image-2574 alignnone" src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/add_sas_blade-556x1024.png" alt width="254" height="468" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/add_sas_blade-556x1024.png 556w, http://localhost:2368/content/images/wordpress/2018/05/add_sas_blade-163x300.png 163w, http://localhost:2368/content/images/wordpress/2018/05/add_sas_blade.png 560w" sizes="(max-width: 254px) 85vw, 254px"></p>
<h3>Acquiring the SAS connection strings</h3>
<p>Once a new SAS policy is created, you need access to the connection string &#8211; this will be used to configure the confluent .NET client.</p>
<p>To capture the SAS connection string, click the SAS policy just created. You will see the following properties blade, which will allow you to copy the SAS policy connection string, by clicking on the copy button besides connection string &#8211; primary key or connection string &#8211; secondary key.</p>
<p><img loading="lazy" class="wp-image-2577 alignnone" src="https://i0.wp.com/notetoself.tech/content/images/wordpress/2018/05/sas_keys-236x300.png?resize=276%2C350" alt width="276" height="350" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/sas_keys-236x300.png 236w, http://localhost:2368/content/images/wordpress/2018/05/sas_keys.png 545w" sizes="(max-width: 276px) 85vw, 276px" data-recalc-dims="1"></p>
<h2>Setting up the .NET Clinet</h2>
<p>Once you get the event hubs namespace configured, makes sure you take note of:</p>
<ol>
<li>Namespace endpoint (&lt;mynamespace&gt;.servicebus.windows.net</li>
<li>SAS policy connection string for either primary or secondary key.</li>
</ol>
<p>You will also need:</p>
<ol>
<li>A .NET Console Application project (4.x or Core).</li>
<li>The Confluent.Kafka component added to the project (you can just add it via Nuget).</li>
</ol>
<h3>Configuring Confluent&#8217;s .NET Client</h3>
<p>Confluent&#8217;s .NET Client  for Apache Kafka is an open source library that allow developers to send (produce) and receive (consume) messages to a event streaming cluster using the Apache Kafka protocol (like Event Hubs).</p>
<p>The library can be found on Nuget for bot .net 4.x and .net standard.</p>
<p><img loading="lazy" class="alignnone wp-image-2579 size-large" src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/confluent_dotnet-1024x320.png" alt width="840" height="263" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/05/confluent_dotnet-1024x320.png 1024w, http://localhost:2368/content/images/wordpress/2018/05/confluent_dotnet-300x94.png 300w, http://localhost:2368/content/images/wordpress/2018/05/confluent_dotnet-768x240.png 768w, http://localhost:2368/content/images/wordpress/2018/05/confluent_dotnet.png 1068w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<h2>Configuring a Confluent Kafka Producer</h2>
<p>Publishing messages to an Event Hub instance using Confluent.Kafka requires very little code:</p>
<pre class="lang:c# mark:16,19-21 decode:true">public static async Task Producer()
{
	try
	{
		// &lt;eventhubnamespace&gt;.servicebus.windows.net:9093
		string brokerList = ConfigurationManager.AppSettings["eventHubsNamespaceURL"];
		// connectionstring - primary or secondary key
		string password = ConfigurationManager.AppSettings["eventHubsConnStr"];
		// &lt;youreventhubinstance&gt;
		string topicName = ConfigurationManager.AppSettings["eventHubName"];
		// a location to a cache of ca certificates
		string caCertLocation = ConfigurationManager.AppSettings["caCertLocation"];


		var config = new Dictionary&lt;string, object&gt; {
			{ "bootstrap.servers", brokerList },
			{ "security.protocol","SASL_SSL" },
			{ "sasl.mechanism","PLAIN" },
			{ "sasl.username", "$ConnectionString"},
			{ "sasl.password", password },
                        { "ssl.ca.location",caCertLocation },
			{ "broker.version.fallback ","0.10.0.0" },
			{ "api.version.fallback.ms","0" }
			{ "debug", "security,broker,protocol" }
		};

		//instantiates the producer
		using (var producer = new Producer&lt;Null, string&gt;(config, null, new StringSerializer(Encoding.UTF8)))
		{
			Console.WriteLine("Initiating Execution");
			for (int x = 0; x &lt; 100; x++)
			{
				var msg = string.Format("This is a sample message - msg # {0} at {1}", x, DateTime.Now.ToString('yyyMMdd_HHmmSSfff'));
				// publishes the message to Event Hubs
				var deliveryReport = await producer.ProduceAsync(topicName, null, msg);
				Console.WriteLine(string.Format("Message {0} sent.", x));
			}
		}
	}
	catch (Exception e)
	{
		Console.WriteLine(string.Format("Exception Ocurred - {0}", e.Message));
	}
}</pre>
<p>The config variable does all the magic here, defining how the producer will connect to a kafka server (or in our case an event hubs instance using the kafka protocol). The kafka protocol available for event hubs uses SASL(Simple Authentication and Security Layer) over SSL (SASL_SSL) as the security protocol, using plain username and password as the authentication method. For this configuration to work, the following configuration items have to be properly defined:</p>
<ul>
<li>bootstrap.server &#8211; this reprsents a list of servers in the cluster that you want to connect to. In our case this is a single endpoint URL using the following format: <strong>&lt;eventhubsnamespace&gt;.servicebus.windows.net:9093</strong> &#8211; where <em>&lt;eventhubsnamespace&gt;</em> is the name of your namespace (e.g. eventhubskafka). Another thing to notice here is that it requires connectivity via port 9093 &#8211; this port indicates that event hubs will connect using SSL &#8211; normal kafka servers usualy also provide a &#8220;clear text&#8221; connection (defaulted to 9092), but that is not available for event hubs for security reasons.</li>
<li>sasl.username &#8211; this represents the username that should be authenticated before the connection is secured. Event hubs require this value to be set to <em>$ConnectionString</em> so it understands that will be using SAS policy connection string to secure the session.</li>
<li>sasl.password &#8211; this represents the password associated to that username. In this case the password is actual a SAS policy connection string, which usually have the following format: <em>Endpoint=sb://&lt;eventhubsnamespace&gt;.servicebus.windows.net/;SharedAccessKeyName=&lt;policyname&gt;;SharedAccessKey=&lt;sharedaccesskey&gt;;EntityPath=&lt;eventhubname&gt;</em>. This is the connection string for the SAS Policy defined earlier.</li>
<li>ssl.ca.location &#8211; this represents the location of the ca certificate associated to the endpoint that you are connected to. This is required because Confluent.Kafka can&#8217;t access the windows certificate store to verify that the endpoint comes from a verified source. This tripped me over for a while, until I found that I could download a &#8220;cache&#8221; of CA certificates from the cURL Mozilla project (this was a tip from the Confuent.Kafka maintainers when I open an issue in the project). You can download this cache  defined in pem format from <a href="https://curl.haxx.se/docs/caextract.html?ref=localhost" target="_blank" rel="noopener">here</a>.</li>
</ul>
<p>Once the producer is created, sending a message is as executing the following command:</p>
<pre class="lang:c# decode:true">var deliveryReport = await producer.ProduceAsync(topicName, null, msg);</pre>
<p>where topicName is the name of the event hub instance you created before.</p>
<h2>Configuring a Confluent.Kafka Consumer</h2>
<p>Similarly, consuming messages from event hubs via Confluent.Kafka requires very little code.</p>
<pre class="lang:c# mark:13,22,25,28,31 decode:true">public static void Consumer(string brokerlist, string password, string consumergroup, string topicname, string cacertlocation)
{
	

	var config = new Dictionary&lt;string, object&gt; {
			{ "bootstrap.servers", brokerlist },
			{ "security.protocol","SASL_SSL" },
			{ "sasl.mechanism","PLAIN" },
			{ "sasl.username", "$ConnectionString"},
			{ "sasl.password", password },
			{ "ssl.ca.location",cacertlocation },
			{ "debug", "security,broker,protocol" },
			{ "group.id", consumergroup },
			{ "auto.commit.interval.ms", 5000 },
			{ "auto.offset.reset", "earliest" },
			{ "broker.version.fallback","0.10.0.0" },
			{ "api.version.fallback.ms","0" }
		};

	using (var consumer = new Consumer&lt;Null, string&gt;(config, null, new StringDeserializer(Encoding.UTF8)))
	{
		consumer.OnMessage += (_, msg)
		  =&gt; Console.WriteLine($"Read '{msg.Value}' from: {msg.TopicPartitionOffset}");

		consumer.OnError += (_, error)
		  =&gt; Console.WriteLine($"Error: {error}");

		consumer.OnConsumeError += (_, msg)
		  =&gt; Console.WriteLine($"Consume error ({msg.TopicPartitionOffset}): {msg.Error}");

		consumer.Subscribe(topicname);

		while (true)
		{
			consumer.Poll(TimeSpan.FromMilliseconds(100));
		}
	}

}</pre>
<p>It also uses a configuration settings approach to define consumer, with the same authentication protocols. When setting up a consumer, you must also define a consumer group, you can think of a consumer group as a view of the event hubs, allowing you to consume data from an event hub instance at your own pace, without having to read it all the way from the start again. You can find more info about consumers and consumer groups <a href="https://docs.microsoft.com/en-us/azure/event-hubs/event-hubs-features?ref=localhost#event-consumers" target="_blank" rel="noopener">here</a>. You configure which consumer group your consumer will user by setting up the <em>group.id</em> property of the config settings.</p>
<p>The consumer code deals with new messages arriving by setting a series of event handlers:</p>
<ul>
<li>consumer.OnMessage &#8211; this handler is triggered when a new message is ready to be processed.</li>
<li>consumer.OnError &#8211; this handler is triggered when any error other then consuming a message occurs.</li>
<li>consumer.OnConsumeError &#8211; this handler is triggered when an error occurs while consuming a message from the event hub.</li>
</ul>
<p>The code snippet below bind the event handlers to the consumer client:</p>
<pre class="lang:c# decode:true">consumer.OnMessage += (_, msg)
  =&gt; Console.WriteLine($"Read '{msg.Value}' from: {msg.TopicPartitionOffset}");

consumer.OnError += (_, error)
  =&gt; Console.WriteLine($"Error: {error}");

consumer.OnConsumeError += (_, msg)
  =&gt; Console.WriteLine($"Consume error ({msg.TopicPartitionOffset}): {msg.Error}");
</pre>
<p>once the consumer is setup, it needs to subscribe to an event hub instance, which is achieved by the following command:</p>
<pre class="lang:c# decode:true">consumer.Subscribe(topicname);</pre>
<p>Finally, we just need to poll event hubs for new messages:</p>
<pre class="lang:c# decode:true">consumer.Poll(TimeSpan.FromMilliseconds(100));</pre>
<h2>In Summary</h2>
<p>Connecting to Event Hubs via a kafka protocol is extremely simple. If you are developing in .NET You can leverage from the Confluent.Kafka  client, which will allow you to connect to it with a few lines of code.</p>
<p>If you, like me already had that code running and pointing to an existing Kafka Cluster, you can definitely reuse the existing code, with a few additional configuration changes.</p>
<p>In case you need a starter, you can find the sample code for this post on my GitHub &#8211; just go <a href="https://github.com/wsilveiranz/EventHubsKafkaSample?ref=localhost" target="_blank" rel="noopener">here</a>.</p>
<p>&nbsp;</p>
<!--kg-card-end: html-->
        </section>

    </article>


</main>


        <section class="gh-container is-grid gh-outer">
            <div class="gh-container-inner gh-inner">
                <h2 class="gh-container-title">Read more</h2>
                <div class="gh-feed">
                        <article class="gh-card post">
    <a class="gh-card-link" href="/and-all-of-a-sudden-its-2022/">
            <figure class="gh-card-image">
                <img
                    srcset="notetoselfblog/content/images/size/w160/format/webp/wordpress/2022/01/soar.png 160w,
                            /content/images/size/w320/format/webp/wordpress/2022/01/soar.png 320w,
                            /content/images/size/w600/format/webp/wordpress/2022/01/soar.png 600w,
                            /content/images/size/w960/format/webp/wordpress/2022/01/soar.png 960w,
                            /content/images/size/w1200/format/webp/wordpress/2022/01/soar.png 1200w,
                            /content/images/size/w2000/format/webp/wordpress/2022/01/soar.png 2000w"
                    sizes="320px"
                    src="notetoselfblog/content/images/size/w600/wordpress/2022/01/soar.png"
                    alt="And all of a sudden, its 2022!"
                    loading="lazy"
                >
            </figure>
        <div class="gh-card-wrapper">
            <h3 class="gh-card-title is-title">And all of a sudden, its 2022!</h3>
                <p class="gh-card-excerpt is-body">And with that, another year goes by. Another year where communities had to revamp themselves and learn how to thrive in a online world. Here in NZ, after what started to look like we were pretty much bat to normal life, the reality of living during a pandemic stroked back,</p>
            <footer class="gh-card-meta"><!--
             -->
                    <span class="gh-card-author">By wsilveiranz</span>
                    <time class="gh-card-date" datetime="2022-01-09">Jan 9, 2022</time>
                <!--
         --></footer>
        </div>
    </a>
</article>                        <article class="gh-card post">
    <a class="gh-card-link" href="/calling-api-management-from-azure-function-using-managed-identities/">
            <figure class="gh-card-image">
                <img
                    srcset="notetoselfblog/content/images/size/w160/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 160w,
                            /content/images/size/w320/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 320w,
                            /content/images/size/w600/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 600w,
                            /content/images/size/w960/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 960w,
                            /content/images/size/w1200/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 1200w,
                            /content/images/size/w2000/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 2000w"
                    sizes="320px"
                    src="notetoselfblog/content/images/size/w600/wordpress/2017/09/field-notes-wide-e1515541406829.jpg"
                    alt="Calling API Management from Azure Function using Managed Identities"
                    loading="lazy"
                >
            </figure>
        <div class="gh-card-wrapper">
            <h3 class="gh-card-title is-title">Calling API Management from Azure Function using Managed Identities</h3>
                <p class="gh-card-excerpt is-body">One of the solutions I am consulting on today is securing a number of APIs with OAuth with client credential flow, using Azure Active Directory as the identity provider. Those APIs are exposed via Azure API Management, which makes the validation of the access tokens provided as simple as injecting</p>
            <footer class="gh-card-meta"><!--
             -->
                    <span class="gh-card-author">By wsilveiranz</span>
                    <time class="gh-card-date" datetime="2021-04-05">Apr 5, 2021</time>
                <!--
         --></footer>
        </div>
    </a>
</article>                        <article class="gh-card post">
    <a class="gh-card-link" href="/countdown-to-global-integration-bootcamp-2021/">
            <figure class="gh-card-image">
                <img
                    srcset="notetoselfblog/content/images/size/w160/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 160w,
                            /content/images/size/w320/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 320w,
                            /content/images/size/w600/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 600w,
                            /content/images/size/w960/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 960w,
                            /content/images/size/w1200/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 1200w,
                            /content/images/size/w2000/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 2000w"
                    sizes="320px"
                    src="notetoselfblog/content/images/size/w600/wordpress/2021/02/GIB-2021-background.jpeg"
                    alt="Countdown to Global Integration Bootcamp 2021"
                    loading="lazy"
                >
            </figure>
        <div class="gh-card-wrapper">
            <h3 class="gh-card-title is-title">Countdown to Global Integration Bootcamp 2021</h3>
                <p class="gh-card-excerpt is-body">Last January, I wrote about this year edition of Global Integration Bootcamp. As you might remember, this year we locked it on 26-27 February (UTC Time) running two different event streams starting at times that can be suitable for the three main time zone areas- APAC, EMEA and Americas.






Lineup</p>
            <footer class="gh-card-meta"><!--
             -->
                    <span class="gh-card-author">By wsilveiranz</span>
                    <time class="gh-card-date" datetime="2021-02-19">Feb 19, 2021</time>
                <!--
         --></footer>
        </div>
    </a>
</article>                        <article class="gh-card post">
    <a class="gh-card-link" href="/global-integration-bootcamp-2021-goes-virtual/">
            <figure class="gh-card-image">
                <img
                    srcset="notetoselfblog/content/images/size/w160/format/webp/wordpress/2020/01/friends_banner.jpg 160w,
                            /content/images/size/w320/format/webp/wordpress/2020/01/friends_banner.jpg 320w,
                            /content/images/size/w600/format/webp/wordpress/2020/01/friends_banner.jpg 600w,
                            /content/images/size/w960/format/webp/wordpress/2020/01/friends_banner.jpg 960w,
                            /content/images/size/w1200/format/webp/wordpress/2020/01/friends_banner.jpg 1200w,
                            /content/images/size/w2000/format/webp/wordpress/2020/01/friends_banner.jpg 2000w"
                    sizes="320px"
                    src="notetoselfblog/content/images/size/w600/wordpress/2020/01/friends_banner.jpg"
                    alt="Global Integration Bootcamp 2021 goes Virtual!!!"
                    loading="lazy"
                >
            </figure>
        <div class="gh-card-wrapper">
            <h3 class="gh-card-title is-title">Global Integration Bootcamp 2021 goes Virtual!!!</h3>
                <p class="gh-card-excerpt is-body">Hey there! Happy New Year!!!





Many of you were asking about if we would be doing another Global Integration Bootcamp this year. I know that there is been a while since we provided any news about it, but the team was trying to come up with a formula that would</p>
            <footer class="gh-card-meta"><!--
             -->
                    <span class="gh-card-author">By wsilveiranz</span>
                    <time class="gh-card-date" datetime="2021-01-12">Jan 12, 2021</time>
                <!--
         --></footer>
        </div>
    </a>
</article>                </div>
            </div>
        </section>

    
    <footer class="gh-footer gh-outer">
    <div class="gh-footer-inner gh-inner">

        <div class="gh-footer-bar">
            <span class="gh-footer-logo is-title">
                    Note to Self - Ghost Edition
            </span>
            <nav class="gh-footer-menu">
                <ul class="nav">
    <li class="nav-sign-up"><a href="#/portal/">Sign up</a></li>
</ul>

            </nav>
            <div class="gh-footer-copyright">
                Powered by <a href="https://ghost.org/" target="_blank" rel="noopener">Ghost</a>
            </div>
        </div>
        
                <section class="gh-footer-signup">
                    <h2 class="gh-footer-signup-header is-title">
                        Note to Self - Ghost Edition
                    </h2>
                    <p class="gh-footer-signup-subhead is-body">
                        Thoughts, stories and ideas.
                    </p>
                    <form class="gh-form" data-members-form>
    <input class="gh-form-input" type="email" placeholder="jamie@example.com" required data-members-email>
    <button class="gh-button" type="submit">
        <span><span>Subscribe</span> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M224.49,136.49l-72,72a12,12,0,0,1-17-17L187,140H40a12,12,0,0,1,0-24H187L135.51,64.48a12,12,0,0,1,17-17l72,72A12,12,0,0,1,224.49,136.49Z"></path></svg></span>
        <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24">
    <g stroke-linecap="round" stroke-width="2" fill="currentColor" stroke="none" stroke-linejoin="round" class="nc-icon-wrapper">
        <g class="nc-loop-dots-4-24-icon-o">
            <circle cx="4" cy="12" r="3"></circle>
            <circle cx="12" cy="12" r="3"></circle>
            <circle cx="20" cy="12" r="3"></circle>
        </g>
        <style data-cap="butt">
            .nc-loop-dots-4-24-icon-o{--animation-duration:0.8s}
            .nc-loop-dots-4-24-icon-o *{opacity:.4;transform:scale(.75);animation:nc-loop-dots-4-anim var(--animation-duration) infinite}
            .nc-loop-dots-4-24-icon-o :nth-child(1){transform-origin:4px 12px;animation-delay:-.3s;animation-delay:calc(var(--animation-duration)/-2.666)}
            .nc-loop-dots-4-24-icon-o :nth-child(2){transform-origin:12px 12px;animation-delay:-.15s;animation-delay:calc(var(--animation-duration)/-5.333)}
            .nc-loop-dots-4-24-icon-o :nth-child(3){transform-origin:20px 12px}
            @keyframes nc-loop-dots-4-anim{0%,100%{opacity:.4;transform:scale(.75)}50%{opacity:1;transform:scale(1)}}
        </style>
    </g>
</svg>        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    <style>
        .checkmark {
            width: 40px;
            height: 40px;
            display: block;
            stroke-width: 2.5;
            stroke: currentColor;
            stroke-miterlimit: 10;
        }

        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke .3s cubic-bezier(0.650, 0.000, 0.450, 1.000) forwards;
        }

        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
    </style>
</svg>    </button>
</form>                </section>

    </div>
</footer>    
</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="notetoselfblog/assets/built/source.js?v=c95e7abf59"></script>



</body>
</html>

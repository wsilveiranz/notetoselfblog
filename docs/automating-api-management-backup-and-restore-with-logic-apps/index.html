<!DOCTYPE html>
<html lang="en">
<head>

    <title>Automating API Management Backup and Restore with Logic Apps</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preload" as="style" href="https://wsilveiranz.github.io/notetoselfblog/assets/built/screen.css?v=c95e7abf59">
    <link rel="preload" as="script" href="https://wsilveiranz.github.io/notetoselfblog/assets/built/source.js?v=c95e7abf59">

    <link rel="stylesheet" type="text/css" href="https://wsilveiranz.github.io/notetoselfblog/assets/built/screen.css?v=c95e7abf59">

    <style>
        :root {
            --background-color: #ffffff
        }
    </style>

    <script>
        /* The script for calculating the color contrast has been taken from
        https://gomakethings.com/dynamically-changing-the-text-color-based-on-background-color-contrast-with-vanilla-js/ */
        var accentColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color');
        accentColor = accentColor.trim().slice(1);
        var r = parseInt(accentColor.substr(0, 2), 16);
        var g = parseInt(accentColor.substr(2, 2), 16);
        var b = parseInt(accentColor.substr(4, 2), 16);
        var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        var textColor = (yiq >= 128) ? 'dark' : 'light';

        document.documentElement.className = `has-${textColor}-text`;
    </script>

    <link rel="canonical" href="http://wsilveiranz.github.io/notetoselfblog/automating-api-management-backup-and-restore-with-logic-apps/">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta property="og:site_name" content="Note to Self - Ghost Edition">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Automating API Management Backup and Restore with Logic Apps">
    <meta property="og:description" content="I’ve been working during the last week or so on setting up a DR strategy for a solution that is based on API Management, Azure Functions and Service Bus. Most of the deployment to the secondary site is dealt by VSTS, but one of the main issues on the">
    <meta property="og:url" content="http://wsilveiranz.github.io/notetoselfblog/automating-api-management-backup-and-restore-with-logic-apps/">
    <meta property="og:image" content="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/exception_management.jpg">
    <meta property="article:published_time" content="2018-06-25T23:35:08.000Z">
    <meta property="article:modified_time" content="2018-09-03T22:18:42.000Z">
    <meta property="article:tag" content="api management">
    <meta property="article:tag" content="automation">
    <meta property="article:tag" content="DR">
    <meta property="article:tag" content="logic apps">
    
    <meta property="article:publisher" content="https://www.facebook.com/ghost">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Automating API Management Backup and Restore with Logic Apps">
    <meta name="twitter:description" content="I’ve been working during the last week or so on setting up a DR strategy for a solution that is based on API Management, Azure Functions and Service Bus. Most of the deployment to the secondary site is dealt by VSTS, but one of the main issues on the">
    <meta name="twitter:url" content="http://wsilveiranz.github.io/notetoselfblog/automating-api-management-backup-and-restore-with-logic-apps/">
    <meta name="twitter:image" content="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/exception_management.jpg">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="wsilveiranz">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="api management, automation, DR, logic apps">
    <meta name="twitter:site" content="@ghost">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="388">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Note to Self - Ghost Edition",
        "url": "http://wsilveiranz.github.io/notetoselfblog/",
        "logo": {
            "@type": "ImageObject",
            "url": "http://wsilveiranz.github.io/notetoselfblog/favicon.ico"
        }
    },
    "author": {
        "@type": "Person",
        "name": "wsilveiranz",
        "image": {
            "@type": "ImageObject",
            "url": "https://secure.gravatar.com/avatar/8cf8f21650fd5355a5b2c08e0f9ca914?s=512&d=mm&r=g",
            "width": 512,
            "height": 512
        },
        "url": "http://wsilveiranz.github.io/notetoselfblog/author/wsilveiranz/",
        "sameAs": []
    },
    "headline": "Automating API Management Backup and Restore with Logic Apps",
    "url": "http://wsilveiranz.github.io/notetoselfblog/automating-api-management-backup-and-restore-with-logic-apps/",
    "datePublished": "2018-06-25T23:35:08.000Z",
    "dateModified": "2018-09-03T22:18:42.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/exception_management.jpg",
        "width": 1024,
        "height": 388
    },
    "keywords": "api management, automation, DR, logic apps",
    "description": "I’ve been working during the last week or so on setting up a DR strategy for a solution that is based on API Management, Azure Functions and Service Bus. Most of the deployment to the secondary site is dealt by VSTS, but one of the main issues on the proposed strategy was the fact that APIM instance utilized is Standard, which doesn’t allow multi-region deployments. This way, to guarantee that all APIM configuration, including users, API policies and subscriptions, I had to leverage from the bac",
    "mainEntityOfPage": "http://wsilveiranz.github.io/notetoselfblog/automating-api-management-backup-and-restore-with-logic-apps/"
}
    </script>

    <meta name="generator" content="Ghost 5.75">
    <link rel="alternate" type="application/rss+xml" title="Note to Self - Ghost Edition" href="http://wsilveiranz.github.io/notetoselfblog/rss/">
    <script defer src="https://cdn.jsdelivr.net/ghost/portal@~2.36/umd/portal.min.js" data-i18n="false" data-ghost="http://wsilveiranz.github.io/notetoselfblog/" data-key="4d946a7b27dfe0cf2428731cab" data-api="http://wsilveiranz.github.io/notetoselfblog/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="4d946a7b27dfe0cf2428731cab" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="http://wsilveiranz.github.io/notetoselfblog/" crossorigin="anonymous"></script>
    
    <link href="http://wsilveiranz.github.io/notetoselfblog/webmentions/receive/" rel="webmention">
    <script defer src="/public/member-attribution.min.js?v=c95e7abf59"></script><style>:root {--ghost-accent-color: #FF1A75;}</style>

</head>
<body class="post-template tag-api-management tag-automation tag-dr tag-logic-apps tag-hash-wordpress tag-hash-import-2023-12-17-09-11 has-sans-title has-sans-body">

<div class="gh-viewport">
    
    <header id="gh-navigation" class="gh-navigation is-middle-logo gh-outer">
    <div class="gh-navigation-inner gh-inner">

        <div class="gh-navigation-brand">
            <a class="gh-navigation-logo is-title" href="http://wsilveiranz.github.io/notetoselfblog">
                    Note to Self - Ghost Edition
            </a>
            <button class="gh-search gh-icon-button" aria-label="Search this site" data-ghost-search>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>            <button class="gh-burger gh-icon-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"></path></svg>                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>            </button>
        </div>

        <nav class="gh-navigation-menu">
            <ul class="nav">
    <li class="nav-home"><a href="http://wsilveiranz.github.io/notetoselfblog/">Home</a></li>
    <li class="nav-about"><a href="http://wsilveiranz.github.io/notetoselfblog/about/">About</a></li>
</ul>

        </nav>

        <div class="gh-navigation-actions">
                <button class="gh-search gh-icon-button" aria-label="Search this site" data-ghost-search>
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>                <div class="gh-navigation-members">
                            <a href="#/portal/signin" data-portal="signin">Sign in</a>
                                <a class="gh-button" href="#/portal/signup" data-portal="signup">Subscribe</a>
                </div>
        </div>

    </div>
</header>

    

<main class="gh-main">

    <article class="gh-article post tag-api-management tag-automation tag-dr tag-logic-apps tag-hash-wordpress tag-hash-import-2023-12-17-09-11">

        <header class="gh-article-header gh-canvas">

                <a class="gh-article-tag" href="http://wsilveiranz.github.io/notetoselfblog/tag/api-management/">api management</a>
            <h1 class="gh-article-title is-title">Automating API Management Backup and Restore with Logic Apps</h1>

            <div class="gh-article-meta">
                <div class="gh-article-author-image">
                            <a href="/author/wsilveiranz/">
                                <img class="author-profile-image" src="https://secure.gravatar.com/avatar/8cf8f21650fd5355a5b2c08e0f9ca914?s&#x3D;512&amp;d&#x3D;mm&amp;r&#x3D;g" alt="wsilveiranz" />
                            </a>
                </div>
                <div class="gh-article-meta-wrapper">
                    <h4 class="gh-article-author-name"><a href="/author/wsilveiranz/">wsilveiranz</a></h4>
                    <div class="gh-article-meta-content">
                        <time class="gh-article-meta-date" datetime="2018-06-25">Jun 25, 2018</time>
                            <span class="gh-article-meta-length"><span class="bull">—</span> 6 min read</span>
                    </div>
                </div>
            </div>

                <figure class="gh-article-image">
        <img
            srcset="notetoselfblog/content/images/size/w320/wordpress/2018/06/exception_management.jpg 320w,
                    /content/images/size/w600/wordpress/2018/06/exception_management.jpg 600w,
                    /content/images/size/w960/wordpress/2018/06/exception_management.jpg 960w,
                    /content/images/size/w1200/wordpress/2018/06/exception_management.jpg 1200w,
                    /content/images/size/w2000/wordpress/2018/06/exception_management.jpg 2000w"
            src="notetoselfblog/content/images/size/w1200/wordpress/2018/06/exception_management.jpg"
            alt="Automating API Management Backup and Restore with Logic Apps"
        >
    </figure>

        </header>

        <section class="gh-content gh-canvas is-body">
            <!--kg-card-begin: html--><p>I&#8217;ve been working during the last week or so on setting up a DR strategy for a solution that is based on API Management, Azure Functions and Service Bus. Most of the deployment to the secondary site is dealt by VSTS, but one of the main issues on the proposed strategy was the fact that APIM instance utilized is Standard, which doesn&#8217;t allow multi-region deployments. This way, to guarantee that all APIM configuration, including users, API policies and subscriptions, I had to leverage from the backup/restore functionality available in APIM, based on the Management API.</p>
<p>The API calls for backup and restores are quite straight forward, but use a authorization token that must be requested before the API call can be executed. So, to automate the process to generate the token and execute the backup or restore API calls, I decided to use Logic Apps.<!--more--></p>
<h2>Preparing the environment</h2>
<p>To generate the authorization token, I need a service principal with the right permissions on both primary and secondary resource groups. This <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal?ref=localhost" target="_blank" rel="noopener">document</a> shows how to implement a service principal.</p>
<p>Once the service principal was setup, I had to setup permissions in a couple of places:</p>
<ul>
<li>Assign delegation permissions to the service principal to access the Azure Management API, so the service principal had permissions to execute the API.</li>
<li>Assign the correct roles on both the primary and dr resource groups, so the service principal could interact properly with them.</li>
</ul>
<h3>Assigning delegation permissions</h3>
<p>To assign delegation permissions to the service principal, follow the steps below:</p>
<ol>
<li>Within your Active Directory tentnat navigate to App Registrations &gt; [YourServicePrincipal]&gt; settings (for example in my case the Service Principal is called APIMAuthentication.</li>
<li>Select Required permissions</li>
<li>Click on +Add</li>
</ol>
<p><img loading="lazy" width="840" height="296" class="alignnone wp-image-2612 size-large" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_permissions_1-1024x361.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_permissions_1-1024x361.png 1024w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_1-300x106.png 300w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_1-768x271.png 768w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_1-1200x423.png 1200w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_1.png 1680w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<p>Select the right API to delegate permissions by clicking on:</p>
<ol>
<li>Select an API</li>
<li>Selecting the Windows Azure Service Management API (remember to click Select afte this)</li>
</ol>
<p><img loading="lazy" width="840" height="192" class="alignnone wp-image-2611 size-large" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_permissions_2-1024x234.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_permissions_2-1024x234.png 1024w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_2-300x68.png 300w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_2-768x175.png 768w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_2-1200x274.png 1200w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_2.png 1680w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<p>Finally select and grant the permissions by following the steps below.</p>
<ol>
<li>Click on Select Permissins</li>
<li>Select Access Azure Service Management as organization users (preview)</li>
</ol>
<p><img loading="lazy" width="840" height="218" class="alignnone wp-image-2610 size-large" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_permissions_3-1024x266.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_permissions_3-1024x266.png 1024w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_3-300x78.png 300w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_3-768x199.png 768w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_3-1200x312.png 1200w, http://localhost:2368/content/images/wordpress/2018/06/apim_permissions_3.png 1329w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<h3>Assign Resource Group roles</h3>
<p>Assigne the following roles on primary and secondary resource groups:</p>
<ul>
<li>Primary resource group &#8211; API Management Service Contributor</li>
</ul>
<p><img loading="lazy" width="840" height="210" class="alignnone wp-image-2603 size-large" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/primary-site-1024x256.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/primary-site-1024x256.png 1024w, http://localhost:2368/content/images/wordpress/2018/06/primary-site-300x75.png 300w, http://localhost:2368/content/images/wordpress/2018/06/primary-site-768x192.png 768w, http://localhost:2368/content/images/wordpress/2018/06/primary-site-1200x300.png 1200w, http://localhost:2368/content/images/wordpress/2018/06/primary-site.png 1680w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<ul>
<li>DR resource group &#8211; Contributor</li>
</ul>
<p><img loading="lazy" width="840" height="206" class="alignnone wp-image-2604 size-large" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/dr-site-permission-1024x251.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/dr-site-permission-1024x251.png 1024w, http://localhost:2368/content/images/wordpress/2018/06/dr-site-permission-300x74.png 300w, http://localhost:2368/content/images/wordpress/2018/06/dr-site-permission-768x188.png 768w, http://localhost:2368/content/images/wordpress/2018/06/dr-site-permission-1200x294.png 1200w, http://localhost:2368/content/images/wordpress/2018/06/dr-site-permission.png 1680w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<p>With the service principal setup, my next step was to implement the logic apps.</p>
<h2>Logic App structure</h2>
<p>Each one of the logic apps followed the same pattern:</p>
<p><img loading="lazy" width="840" height="471" class="alignnone wp-image-2606" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/DR-logic-app-pattern.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/DR-logic-app-pattern.png 931w, http://localhost:2368/content/images/wordpress/2018/06/DR-logic-app-pattern-300x168.png 300w, http://localhost:2368/content/images/wordpress/2018/06/DR-logic-app-pattern-768x431.png 768w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<h3>Trigger Schema</h3>
<p>The logic app require the following input to run:</p>
<pre class="lang:default decode:true">{
	"applicationId": "467ee8da-b314-4ce9-8816-552280e****",
	"clientSecret": "4GUcWXsQt6ZySewexBSeF4XYqi3XypMNhG**********",
	"tenantId": "6dda9ee9-7661-42ac-8ea3-b5eb4e3*****",
	"subscriptionId": "a327e0b5-4c4b-491e-9424-************",
	"resourceGroup": "apimdrresourcegroup",
	"apimInstance": "sampleapim",
	"backupName": "apimbackup",
	"operation": "backup|restore", 
	"containerName": "backup", 
	"storageAccount": "apimdrstorage", 
	"accessKey": "EDuZ52iakPUzRkzbQtlhdgysTB1ZjJ44heiR/9nHn3vlA/NCLJxAASn2N6ief2ExK/GouRdsD0GwvT**********" 
}</pre>
<p>&nbsp;</p>
<ul>
<li>applicationId &#8211; the unique identifier of the service principal</li>
<li>clientSecret &#8211; the key created for the service principal</li>
<li>tenantId &#8211; the id of the active directory hosting the service principal</li>
<li>subscriptionId &#8211; the id of the subscription hosting the Primary or DR resource group</li>
<li>resourceGroup &#8211; the name of the Primary or DR resource Group</li>
<li>apimInstance &#8211; the name of the APIM instance being backed up or restored</li>
<li>backupName &#8211; the name of the blob containing the backup image</li>
<li>operation &#8211; the operation being performed (backup or restore)</li>
<li>containerName &#8211; the name of the container storing the backup image</li>
<li>storageAccount &#8211; the name of the storage account hosting the backup image</li>
<li>accessKey &#8211; an access key for read/write the backup image.</li>
</ul>
<p>A sample input payload would look like this:</p>
<pre class="lang:default decode:true">{
  "applicationId": "467ee8da-b314-4ce9-8816-552280e****",
  "clientSecret": "4GUcWXsQt6ZySewexBSeF4XYqi3XypMNhG**********",
  "tenantId": "6dda9ee9-7661-42ac-8ea3-b5eb4e3*****",
  "subscriptionId": "a327e0b5-4c4b-491e-9424-************",
  "resourceGroup": "apimdrresourcegroup",
  "apimInstance": "sampleapim",
  "backupName": "apimbackup",
  "operation": "backup|restore",
  "containerName": "backup",
  "storageAccount": "apimdrstorage",
  "accessKey": "EDuZ52iakPUzRkzbQtlhdgysTB1ZjJ44heiR/9nHn3vlA/NCLJxAASn2N6ief2ExK/GouRdsD0GwvT**********"
}</pre>
<p>The API call that generates the authentication token requires that the payload to be sent using url-form encoded, so instead of the usual json payload, the message must be sent in the following format:</p>
<p><img loading="lazy" width="840" height="199" class="alignnone wp-image-2614 size-large" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_autentication_create_autentication_body-1024x243.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_autentication_create_autentication_body-1024x243.png 1024w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_create_autentication_body-300x71.png 300w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_create_autentication_body-768x182.png 768w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_create_autentication_body.png 1064w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<p>In the payload above:</p>
<ul>
<li>client_id &#8211; this is the client unique identifier (in this case the unique id of the service principal, which is passed to the logic app as <strong>applicationId</strong>)</li>
<li>client_secret &#8211; this is the client secret generated at AD (passed to the logic app as <strong>clientSecret</strong>)</li>
<li>grant_type &#8211; this is set to <strong>client_credentials</strong>, so the API knows how to authenticate</li>
<li>resource &#8211; this is set to <strong>https://management.azure.com</strong> &#8211; which is the API we will hit in the next step (and which we delegated permisssions to).</li>
</ul>
<p>This payload is passed as the body of an HTTP action with the following configuration:</p>
<p><img loading="lazy" width="840" height="386" class="alignnone wp-image-2615 size-large" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_autentication_token_request-1024x470.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_autentication_token_request-1024x470.png 1024w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_token_request-300x138.png 300w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_token_request-768x352.png 768w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_token_request.png 1070w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<p>The authentication token is requested from:</p>
<pre class="lang:default decode:true ">https://login.microsoftonline.com/@{triggerBody()?['tenantId']}/oauth2/token</pre>
<p>where <strong>tenantId</strong> is the ID of the AD tenant where the resources are deployed (and the service principal was created). Also notice the <strong>Content-Type: application/x-www-form-urlencoded</strong> header. Finally body received the output from the previous compose action were the url-form encoded payload was created.</p>
<p>The result of this execution is an object with multiple properties. One in particular &#8211; access_token &#8211; is the one we required. This will be required to create the authentication on the next API call. Since this is a bearer token authentication, this is represented as a Raw authentication on the next API call. I&#8217;ve created initializing a variable (bearertoken) with the following format:</p>
<pre class="lang:default decode:true ">@concat('Bearer ',body('Request_Auhtentication_Token')['access_token'])</pre>
<p>Finally, the api call for the backup have the following format:</p>
<p><img loading="lazy" width="840" height="762" class="alignnone wp-image-2618 size-large" alt src="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_autentication_create_invoke_management_api-1024x929.png" srcset="http://wsilveiranz.github.io/notetoselfblog/content/images/wordpress/2018/06/apim_autentication_create_invoke_management_api-1024x929.png 1024w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_create_invoke_management_api-300x272.png 300w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_create_invoke_management_api-768x697.png 768w, http://localhost:2368/content/images/wordpress/2018/06/apim_autentication_create_invoke_management_api.png 1072w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 67vw, (max-width: 1362px) 62vw, 840px"></p>
<p>The api endpoint is created using the following properties:</p>
<ul>
<li>subscriptionId &#8211; the unique identifier of the subscription where the API Management instance is deployed (either the main instance or the DR instance), passed as a parameter when the logic app is invoked</li>
<li>resourceGroup &#8211; the name of the resource group where the apim instance is deployed.</li>
<li>apimInstance &#8211; the name of the apim instance being backed up or restored.</li>
<li>operation &#8211; the name of the operation being performed &#8211; this should be either backup or restore, as they are the only operations accepted.</li>
</ul>
<p>The body in this case is a normal json payload (hence the <strong>Content-Type: application/json</strong> in the header) and have the following properties:</p>
<ul>
<li>accessKey &#8211; the SAS key for the container where the backup blob will be deployed (or where it will be read from).</li>
<li>backupName &#8211; the name of the blob that will hold the backup</li>
<li>containerName &#8211; the name of the container holding the backup blob</li>
<li>storageAccount &#8211; the name of the storage account where the container has been deployed.</li>
</ul>
<p>Most important in this case, is the authentication method, which is set to Raw, and have the value of the bearertoken variable (initialized as &#8220;Bearer &#8220;+access_token).</p>
<h2>Usage scenarios</h2>
<p>I&#8217;ve implemented this logic app to automate backups and to execute restore during a DR event for a project where APIM has been used. The way I am taking advantage of this logic app is:</p>
<ul>
<li>I am creating a logic app that runs on a recurrence (in my case daily, but you can set it up on whatever retention makes sense) and invoke this logic app with the correct inputs.</li>
<li>I&#8217;ve mad a small change in the original logic app, that instead of using simply @triggerBody()[&#8216;backupName&#8217;] as the name of the backup blob, I am using:</li>
</ul>
<pre class="lang:default decode:true ">@concat(triggerBody()?['backupName'],'_',convertFromUtc(utcNow(),'New Zealand Standard Time','yyyyMMdd'))</pre>
<p>So I don&#8217;t override older backups (I am planning to use the latest updates from the storage account to set a retention policy and remove backups older than x days).</p>
<ul>
<li>I&#8217;ve cloned that logic app and created a specific logic app for backup and restore. This way I can give specific permissions for each one of them individually. In this case I am hardcoding backup or restore on the Management API call.</li>
</ul>
<p>You can find an ARM template to deploy this logic app <a href="https://github.com/wsilveiranz/apimbackuprestore?ref=localhost" target="_blank" rel="noopener">here</a>, if you&#8217;re interested.</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<!--kg-card-end: html-->
        </section>

    </article>


</main>


        <section class="gh-container is-grid gh-outer">
            <div class="gh-container-inner gh-inner">
                <h2 class="gh-container-title">Read more</h2>
                <div class="gh-feed">
                        <article class="gh-card post">
    <a class="gh-card-link" href="/and-all-of-a-sudden-its-2022/">
            <figure class="gh-card-image">
                <img
                    srcset="notetoselfblog/content/images/size/w160/format/webp/wordpress/2022/01/soar.png 160w,
                            /content/images/size/w320/format/webp/wordpress/2022/01/soar.png 320w,
                            /content/images/size/w600/format/webp/wordpress/2022/01/soar.png 600w,
                            /content/images/size/w960/format/webp/wordpress/2022/01/soar.png 960w,
                            /content/images/size/w1200/format/webp/wordpress/2022/01/soar.png 1200w,
                            /content/images/size/w2000/format/webp/wordpress/2022/01/soar.png 2000w"
                    sizes="320px"
                    src="notetoselfblog/content/images/size/w600/wordpress/2022/01/soar.png"
                    alt="And all of a sudden, its 2022!"
                    loading="lazy"
                >
            </figure>
        <div class="gh-card-wrapper">
            <h3 class="gh-card-title is-title">And all of a sudden, its 2022!</h3>
                <p class="gh-card-excerpt is-body">And with that, another year goes by. Another year where communities had to revamp themselves and learn how to thrive in a online world. Here in NZ, after what started to look like we were pretty much bat to normal life, the reality of living during a pandemic stroked back,</p>
            <footer class="gh-card-meta"><!--
             -->
                    <span class="gh-card-author">By wsilveiranz</span>
                    <time class="gh-card-date" datetime="2022-01-09">Jan 9, 2022</time>
                <!--
         --></footer>
        </div>
    </a>
</article>                        <article class="gh-card post">
    <a class="gh-card-link" href="/calling-api-management-from-azure-function-using-managed-identities/">
            <figure class="gh-card-image">
                <img
                    srcset="notetoselfblog/content/images/size/w160/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 160w,
                            /content/images/size/w320/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 320w,
                            /content/images/size/w600/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 600w,
                            /content/images/size/w960/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 960w,
                            /content/images/size/w1200/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 1200w,
                            /content/images/size/w2000/format/webp/wordpress/2017/09/field-notes-wide-e1515541406829.jpg 2000w"
                    sizes="320px"
                    src="notetoselfblog/content/images/size/w600/wordpress/2017/09/field-notes-wide-e1515541406829.jpg"
                    alt="Calling API Management from Azure Function using Managed Identities"
                    loading="lazy"
                >
            </figure>
        <div class="gh-card-wrapper">
            <h3 class="gh-card-title is-title">Calling API Management from Azure Function using Managed Identities</h3>
                <p class="gh-card-excerpt is-body">One of the solutions I am consulting on today is securing a number of APIs with OAuth with client credential flow, using Azure Active Directory as the identity provider. Those APIs are exposed via Azure API Management, which makes the validation of the access tokens provided as simple as injecting</p>
            <footer class="gh-card-meta"><!--
             -->
                    <span class="gh-card-author">By wsilveiranz</span>
                    <time class="gh-card-date" datetime="2021-04-05">Apr 5, 2021</time>
                <!--
         --></footer>
        </div>
    </a>
</article>                        <article class="gh-card post">
    <a class="gh-card-link" href="/countdown-to-global-integration-bootcamp-2021/">
            <figure class="gh-card-image">
                <img
                    srcset="notetoselfblog/content/images/size/w160/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 160w,
                            /content/images/size/w320/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 320w,
                            /content/images/size/w600/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 600w,
                            /content/images/size/w960/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 960w,
                            /content/images/size/w1200/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 1200w,
                            /content/images/size/w2000/format/webp/wordpress/2021/02/GIB-2021-background.jpeg 2000w"
                    sizes="320px"
                    src="notetoselfblog/content/images/size/w600/wordpress/2021/02/GIB-2021-background.jpeg"
                    alt="Countdown to Global Integration Bootcamp 2021"
                    loading="lazy"
                >
            </figure>
        <div class="gh-card-wrapper">
            <h3 class="gh-card-title is-title">Countdown to Global Integration Bootcamp 2021</h3>
                <p class="gh-card-excerpt is-body">Last January, I wrote about this year edition of Global Integration Bootcamp. As you might remember, this year we locked it on 26-27 February (UTC Time) running two different event streams starting at times that can be suitable for the three main time zone areas- APAC, EMEA and Americas.






Lineup</p>
            <footer class="gh-card-meta"><!--
             -->
                    <span class="gh-card-author">By wsilveiranz</span>
                    <time class="gh-card-date" datetime="2021-02-19">Feb 19, 2021</time>
                <!--
         --></footer>
        </div>
    </a>
</article>                        <article class="gh-card post">
    <a class="gh-card-link" href="/global-integration-bootcamp-2021-goes-virtual/">
            <figure class="gh-card-image">
                <img
                    srcset="notetoselfblog/content/images/size/w160/format/webp/wordpress/2020/01/friends_banner.jpg 160w,
                            /content/images/size/w320/format/webp/wordpress/2020/01/friends_banner.jpg 320w,
                            /content/images/size/w600/format/webp/wordpress/2020/01/friends_banner.jpg 600w,
                            /content/images/size/w960/format/webp/wordpress/2020/01/friends_banner.jpg 960w,
                            /content/images/size/w1200/format/webp/wordpress/2020/01/friends_banner.jpg 1200w,
                            /content/images/size/w2000/format/webp/wordpress/2020/01/friends_banner.jpg 2000w"
                    sizes="320px"
                    src="notetoselfblog/content/images/size/w600/wordpress/2020/01/friends_banner.jpg"
                    alt="Global Integration Bootcamp 2021 goes Virtual!!!"
                    loading="lazy"
                >
            </figure>
        <div class="gh-card-wrapper">
            <h3 class="gh-card-title is-title">Global Integration Bootcamp 2021 goes Virtual!!!</h3>
                <p class="gh-card-excerpt is-body">Hey there! Happy New Year!!!





Many of you were asking about if we would be doing another Global Integration Bootcamp this year. I know that there is been a while since we provided any news about it, but the team was trying to come up with a formula that would</p>
            <footer class="gh-card-meta"><!--
             -->
                    <span class="gh-card-author">By wsilveiranz</span>
                    <time class="gh-card-date" datetime="2021-01-12">Jan 12, 2021</time>
                <!--
         --></footer>
        </div>
    </a>
</article>                </div>
            </div>
        </section>

    
    <footer class="gh-footer gh-outer">
    <div class="gh-footer-inner gh-inner">

        <div class="gh-footer-bar">
            <span class="gh-footer-logo is-title">
                    Note to Self - Ghost Edition
            </span>
            <nav class="gh-footer-menu">
                <ul class="nav">
    <li class="nav-sign-up"><a href="#/portal/">Sign up</a></li>
</ul>

            </nav>
            <div class="gh-footer-copyright">
                Powered by <a href="https://ghost.org/" target="_blank" rel="noopener">Ghost</a>
            </div>
        </div>
        
                <section class="gh-footer-signup">
                    <h2 class="gh-footer-signup-header is-title">
                        Note to Self - Ghost Edition
                    </h2>
                    <p class="gh-footer-signup-subhead is-body">
                        Thoughts, stories and ideas.
                    </p>
                    <form class="gh-form" data-members-form>
    <input class="gh-form-input" type="email" placeholder="jamie@example.com" required data-members-email>
    <button class="gh-button" type="submit">
        <span><span>Subscribe</span> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M224.49,136.49l-72,72a12,12,0,0,1-17-17L187,140H40a12,12,0,0,1,0-24H187L135.51,64.48a12,12,0,0,1,17-17l72,72A12,12,0,0,1,224.49,136.49Z"></path></svg></span>
        <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24">
    <g stroke-linecap="round" stroke-width="2" fill="currentColor" stroke="none" stroke-linejoin="round" class="nc-icon-wrapper">
        <g class="nc-loop-dots-4-24-icon-o">
            <circle cx="4" cy="12" r="3"></circle>
            <circle cx="12" cy="12" r="3"></circle>
            <circle cx="20" cy="12" r="3"></circle>
        </g>
        <style data-cap="butt">
            .nc-loop-dots-4-24-icon-o{--animation-duration:0.8s}
            .nc-loop-dots-4-24-icon-o *{opacity:.4;transform:scale(.75);animation:nc-loop-dots-4-anim var(--animation-duration) infinite}
            .nc-loop-dots-4-24-icon-o :nth-child(1){transform-origin:4px 12px;animation-delay:-.3s;animation-delay:calc(var(--animation-duration)/-2.666)}
            .nc-loop-dots-4-24-icon-o :nth-child(2){transform-origin:12px 12px;animation-delay:-.15s;animation-delay:calc(var(--animation-duration)/-5.333)}
            .nc-loop-dots-4-24-icon-o :nth-child(3){transform-origin:20px 12px}
            @keyframes nc-loop-dots-4-anim{0%,100%{opacity:.4;transform:scale(.75)}50%{opacity:1;transform:scale(1)}}
        </style>
    </g>
</svg>        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    <style>
        .checkmark {
            width: 40px;
            height: 40px;
            display: block;
            stroke-width: 2.5;
            stroke: currentColor;
            stroke-miterlimit: 10;
        }

        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke .3s cubic-bezier(0.650, 0.000, 0.450, 1.000) forwards;
        }

        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }
    </style>
</svg>    </button>
</form>                </section>

    </div>
</footer>    
</div>

    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>

    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
<script src="notetoselfblog/assets/built/source.js?v=c95e7abf59"></script>



</body>
</html>
